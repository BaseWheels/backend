import { Router, Request, Response } from "express";
import { prisma } from "../lib/prisma";
import { auth, AuthRequest } from "../middleware/auth";
import { executeAdminBuyback, getAdminWalletAddress } from "../blockchain/admin-buyback-client";
import { getBuybackPrice } from "../config/buyback-prices";

const router = Router();

/**
 * POST /api/admin-buyback/sell
 * Sell car to admin: Transfer NFT to admin, receive IDRX payment
 */
router.post("/admin-buyback/sell", auth, async (req: Request, res: Response) => {
  try {
    const { userId, walletAddress } = req as AuthRequest;
    const { tokenId } = req.body;

    console.log("=== Admin Buyback Request ===");
    console.log("User ID:", userId);
    console.log("User Wallet:", walletAddress);
    console.log("Token ID:", tokenId);

    // 1. Validate auth
    if (!userId || !walletAddress) {
      res.status(401).json({ error: "Unauthorized" });
      return;
    }

    // 2. Validate input
    if (!tokenId || typeof tokenId !== "number") {
      res.status(400).json({
        error: "Token ID is required and must be a number",
      });
      return;
    }

    // 3. Check if car exists in database and user owns it
    const car = await prisma.car.findUnique({
      where: { tokenId },
      include: { listing: true },
    });

    if (!car) {
      res.status(404).json({
        error: "Car not found",
      });
      return;
    }

    if (car.ownerId !== userId) {
      res.status(403).json({
        error: "You do not own this car",
      });
      return;
    }

    // 4. Check if car is redeemed
    if (car.isRedeemed) {
      res.status(400).json({
        error: "Car has been redeemed and cannot be sold",
      });
      return;
    }

    // 5. Check if car is listed on marketplace
    if (car.listing && car.listing.status === "active") {
      res.status(400).json({
        error: "Car is currently listed on marketplace. Please cancel the listing first.",
      });
      return;
    }

    // 6. Determine rarity and get buyback price
    let rarity = "common";
    if (car.series?.includes("Hypercar") || car.series?.includes("Limited Edition")) {
      rarity = "legendary";
    } else if (car.series?.includes("German Engineering") || car.series?.includes("Supercar")) {
      rarity = "epic";
    } else if (car.series?.includes("JDM Legend") || car.series?.includes("Sport")) {
      rarity = "rare";
    }

    const buybackPrice = getBuybackPrice(rarity);
    console.log("Rarity:", rarity);
    console.log("Buyback Price:", buybackPrice);

    // 7. Execute blockchain transactions
    let nftTxHash: string;
    let idrxTxHash: string;
    try {
      const result = await executeAdminBuyback(
        walletAddress as string,
        tokenId,
        buybackPrice
      );
      nftTxHash = result.nftTxHash;
      idrxTxHash = result.idrxTxHash;
    } catch (error) {
      console.error("Blockchain transaction failed:", error);
      res.status(500).json({
        error: "Failed to execute blockchain transaction",
        details: error instanceof Error ? error.message : "Unknown error",
      });
      return;
    }

    // 8. Update database - transfer car to admin
    const adminWallet = getAdminWalletAddress();

    // Find or create admin user
    let adminUser = await prisma.user.findUnique({
      where: { walletAddress: adminWallet.toLowerCase() },
    });

    if (!adminUser) {
      adminUser = await prisma.user.create({
        data: {
          id: `admin_${adminWallet.toLowerCase()}`,
          walletAddress: adminWallet.toLowerCase(),
        },
      });
    }

    // Update car ownership
    await prisma.car.update({
      where: { tokenId },
      data: {
        ownerId: adminUser.id,
        soldToAdminAt: new Date(),
      },
    });

    console.log("Car ownership transferred to admin in database");

    // 9. Return success response
    res.status(200).json({
      success: true,
      message: "Car sold to admin successfully",
      data: {
        tokenId,
        rarity,
        buybackPrice,
        nftTxHash,
        idrxTxHash,
        carDetails: {
          modelName: car.modelName,
          series: car.series,
        },
      },
    });
  } catch (error) {
    console.error("Admin buyback error:", error);
    res.status(500).json({
      error: "Internal server error while processing admin buyback",
      details: error instanceof Error ? error.message : "Unknown error",
    });
  }
});

/**
 * GET /api/admin-buyback/prices
 * Get current buyback prices for all rarities
 */
router.get("/admin-buyback/prices", auth, async (_req: Request, res: Response) => {
  try {
    const prices = {
      common: getBuybackPrice("common"),
      rare: getBuybackPrice("rare"),
      epic: getBuybackPrice("epic"),
      legendary: getBuybackPrice("legendary"),
    };

    res.status(200).json({
      success: true,
      prices,
    });
  } catch (error) {
    console.error("Get buyback prices error:", error);
    res.status(500).json({
      error: "Failed to get buyback prices",
    });
  }
});

export default router;
